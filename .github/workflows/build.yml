name: Build fuckfile

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Linux x86_64
        run: |
          gcc -o fuckfile-linux-x64 main.c -O2 -static
          strip fuckfile-linux-x64
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fuckfile-linux-x64
          path: fuckfile-linux-x64

  build-linux-x86:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install 32-bit libraries
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib libc6-dev-i386
      
      - name: Build Linux i686
        run: |
          gcc -m32 -o fuckfile-linux-x86 main.c -O2 -static
          strip fuckfile-linux-x86
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fuckfile-linux-x86
          path: fuckfile-linux-x86

  build-linux-arm:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - arch: aarch64
            gcc: gcc-aarch64-linux-gnu
            strip: aarch64-linux-gnu-strip
            output: fuckfile-linux-arm64
          - arch: arm
            gcc: gcc-arm-linux-gnueabihf
            strip: arm-linux-gnueabihf-strip
            output: fuckfile-linux-armv7
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.gcc }}
      
      - name: Build Linux ARM
        run: |
          ${{ matrix.gcc }} -o ${{ matrix.output }} main.c -O2 -static
          ${{ matrix.strip }} ${{ matrix.output }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: ${{ matrix.output }}

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            platform: x64
          - arch: arm64
            platform: arm64
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.platform }}
      
      - name: Build Windows
        run: |
          cl /O2 main.c /Fe:fuckfile-windows-${{ matrix.arch }}.exe
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fuckfile-windows-${{ matrix.arch }}
          path: fuckfile-windows-${{ matrix.arch }}.exe

  build-windows-x86:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup MinGW
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x86
      
      - name: Build Windows x86
        run: |
          gcc -o fuckfile-windows-x86.exe main.c -O2 -static
          strip fuckfile-windows-x86.exe
        shell: bash
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fuckfile-windows-x86
          path: fuckfile-windows-x86.exe

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64-v8a
            abi: aarch64-linux-android
            api: 21
            output: fuckfile-android-arm64
          - arch: armeabi-v7a
            abi: armv7a-linux-androideabi
            api: 21
            output: fuckfile-android-armv7
          - arch: x86_64
            abi: x86_64-linux-android
            api: 21
            output: fuckfile-android-x86_64
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true
      
      - name: Build Android
        run: |
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.abi }}${{ matrix.api }}-clang \
            -o ${{ matrix.output }} main.c -O2 -static
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip ${{ matrix.output }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: ${{ matrix.output }}