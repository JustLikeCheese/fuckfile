name: Build fuckfile

on:
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows'
        required: true
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux'
        required: true
        type: boolean
        default: true
      build_android:
        description: 'Build Android'
        required: true
        type: boolean
        default: true
      run_tests:
        description: 'Run Tests'
        required: true
        type: boolean
        default: false

jobs:
  # ==================================================================================
  # 1. BUILD LINUX (Inline Logic: ARM -> Clean -> x86)
  # ==================================================================================
  build-linux:
    if: ${{ inputs.build_linux }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build ARM & x86 (Inline)
        run: |
          echo "=== Phase 1: ARM Builds ==="
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
            gcc-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
          
          echo "Building ARM64..."
          aarch64-linux-gnu-gcc -o fuckfile-linux-arm64 main.c -O2 -static
          aarch64-linux-gnu-strip fuckfile-linux-arm64
          chmod +x fuckfile-linux-arm64
          
          echo "Building ARMv7..."
          arm-linux-gnueabihf-gcc -o fuckfile-linux-armv7 main.c -O2 -static
          arm-linux-gnueabihf-strip fuckfile-linux-armv7
          chmod +x fuckfile-linux-armv7
          
          echo "=== Cleaning up ARM toolchain ==="
          sudo apt-get remove -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
          sudo apt-get autoremove -y
          
          echo "=== Phase 2: x86/x64 Builds ==="
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib
          
          echo "Building x64..."
          gcc -o fuckfile-linux-x64 main.c -O2 -static
          strip fuckfile-linux-x64
          chmod +x fuckfile-linux-x64
          
          echo "Building x86..."
          gcc -m32 -o fuckfile-linux-x86 main.c -O2 -static
          strip fuckfile-linux-x86
          chmod +x fuckfile-linux-x86
      
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: tmp-linux
          path: fuckfile-linux-*
          retention-days: 1

  # ==================================================================================
  # 2. BUILD WINDOWS MinGW (Inline Logic)
  # ==================================================================================
  build-windows-mingw:
    if: ${{ inputs.build_windows }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-i686-gcc
      - name: Build
        shell: msys2 {0}
        run: |
          echo "Building x64..."
          gcc -o fuckfile-windows-x64.exe main.c -O2 -static
          strip fuckfile-windows-x64.exe
          
          echo "Building x86..."
          gcc -o fuckfile-windows-x86.exe main.c -O2 -static
          strip fuckfile-windows-x86.exe
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: tmp-windows-mingw
          path: fuckfile-windows-*.exe
          retention-days: 1

  # ==================================================================================
  # 3. BUILD WINDOWS ARM64 (Inline Logic)
  # ==================================================================================
  build-windows-arm64:
    if: ${{ inputs.build_windows }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup MSVC ARM64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64_arm64
      - name: Build
        shell: cmd
        run: |
          cl /O2 main.c /Fe:fuckfile-windows-arm64.exe
          del main.obj
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: tmp-windows-arm64
          path: fuckfile-windows-arm64.exe
          retention-days: 1

  # ==================================================================================
  # 4. BUILD ANDROID (Inline Logic)
  # ==================================================================================
  build-android:
    if: ${{ inputs.build_android }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true
      
      - name: Build
        run: |
          NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          # Using standard build flags. 
          # Note: We are NOT adding extra flags for QEMU anymore since we won't run QEMU.
          
          echo "Building ARM64..."
          $NDK_BIN/aarch64-linux-android21-clang -o fuckfile-android-arm64 main.c -O2 -static
          $NDK_BIN/llvm-strip fuckfile-android-arm64
          chmod +x fuckfile-android-arm64
          
          echo "Building ARMv7..."
          $NDK_BIN/armv7a-linux-androideabi21-clang -o fuckfile-android-armv7 main.c -O2 -static
          $NDK_BIN/llvm-strip fuckfile-android-armv7
          chmod +x fuckfile-android-armv7
          
          echo "Building x86_64..."
          $NDK_BIN/x86_64-linux-android21-clang -o fuckfile-android-x86_64 main.c -O2 -static
          $NDK_BIN/llvm-strip fuckfile-android-x86_64
          chmod +x fuckfile-android-x86_64
          
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: tmp-android
          path: fuckfile-android-*
          retention-days: 1

  # ==================================================================================
  # 5. TEST LINUX (Inline Bash Script)
  # ==================================================================================
  test-linux:
    if: ${{ inputs.run_tests && inputs.build_linux }}
    needs: [build-linux]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, x86, arm64, armv7]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: tmp-linux
      - name: Test
        run: |
          sudo apt-get update && sudo apt-get install -y --no-install-recommends qemu-user-static xxd
          chmod +x fuckfile-linux-*
          
          ARCH="${{ matrix.arch }}"
          BINARY="./fuckfile-linux-${ARCH}"
          
          # Determine Runner
          RUNNER=""
          if [ "$ARCH" = "arm64" ]; then RUNNER="qemu-aarch64-static"; fi
          if [ "$ARCH" = "armv7" ]; then RUNNER="qemu-arm-static"; fi
          
          echo "=== fuckfile Test - Linux $ARCH ===" > test.log
          echo "Date: $(date)" >> test.log
          echo "Binary: $BINARY" >> test.log
          
          echo "" >> test.log
          echo "Test 1: Display help" >> test.log
          $RUNNER $BINARY >> test.log 2>&1 || true
          
          echo "" >> test.log
          echo "Test 2: Fuck single file" >> test.log
          echo "Hello World" > test1.txt
          $RUNNER $BINARY -f test1.txt >> test.log 2>&1
          stat -c "Size: %s" test1.txt >> test.log
          xxd test1.txt | head -1 >> test.log
          
          echo "" >> test.log
          echo "Test 3: Truncate" >> test.log
          echo "Test" > test2.txt
          $RUNNER $BINARY -f -s test2.txt >> test.log 2>&1
          stat -c "Size: %s" test2.txt >> test.log
          
          echo "" >> test.log
          echo "Test 4: Recursive" >> test.log
          mkdir -p testdir/sub
          echo "1" > testdir/f1
          echo "2" > testdir/sub/f2
          $RUNNER $BINARY -f -r testdir >> test.log 2>&1
          find testdir -type f -exec stat -c "%n: %s bytes" {} \; >> test.log
          
          cat test.log
          mv test.log test-linux-${ARCH}.log

      - uses: actions/upload-artifact@v4
        with:
          name: log-linux-${{ matrix.arch }}
          path: test-linux-${{ matrix.arch }}.log

  # ==================================================================================
  # 6. TEST WINDOWS (Inline PowerShell Script)
  # ==================================================================================
  test-windows:
    if: ${{ inputs.run_tests && inputs.build_windows }}
    needs: [build-windows-mingw, build-windows-arm64]
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86, arm64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        if: matrix.arch != 'arm64'
        with:
          name: tmp-windows-mingw
      - uses: actions/download-artifact@v4
        if: matrix.arch == 'arm64'
        with:
          name: tmp-windows-arm64
      
      - name: Test
        shell: pwsh
        run: |
          $Arch = "${{ matrix.arch }}"
          $Binary = ".\fuckfile-windows-$Arch.exe"
          $LogFile = "test-windows-$Arch.log"
          
          if ($Arch -eq "arm64") {
             "Skipping native run on ARM64" | Out-File $LogFile
             return
          }
          
          $Output = @()
          $Output += "=== fuckfile Test - Windows $Arch ==="
          $Output += "Date: $(Get-Date)"
          
          # Test 1
          $Output += "`nTest 1: Help"
          $Output += (& $Binary | Out-String).Trim()
          
          # Test 2
          $Output += "`nTest 2: Single File"
          "Hello World" | Out-File test1.txt -NoNewline
          $T1 = (Get-Item test1.txt).LastWriteTime
          & $Binary -f test1.txt
          $T2 = (Get-Item test1.txt).LastWriteTime
          if ($T1.ToString("yyyyMMddHHmmss") -eq $T2.ToString("yyyyMMddHHmmss")) { $Output += "Time Preserved: YES" } else { $Output += "Time Preserved: NO" }
          
          # Test 3
          $Output += "`nTest 3: Truncate"
          "Test" | Out-File test2.txt -NoNewline
          & $Binary -f -s test2.txt
          $Size = (Get-Item test2.txt).Length
          $Output += "New Size: $Size"
          
          # Test 6
          $Output += "`nTest 6: Recursive"
          if (Test-Path testdir) { Remove-Item testdir -Recurse -Force }
          New-Item -Type Directory -Path testdir\sub -Force | Out-Null
          "1" | Out-File testdir\f1
          "2" | Out-File testdir\sub\f2
          & $Binary -f -r testdir
          $Files = Get-ChildItem testdir -Recurse -File
          foreach ($f in $Files) { $Output += "$($f.FullName): $($f.Length) bytes" }
          
          $Output | Out-File $LogFile -Encoding UTF8
          cat $LogFile

      - uses: actions/upload-artifact@v4
        with:
          name: log-windows-${{ matrix.arch }}
          path: test-windows-${{ matrix.arch }}.log

  # ==================================================================================
  # 7. TEST ANDROID (Verification Only - QEMU Unstable)
  # ==================================================================================
  test-android:
    if: ${{ inputs.run_tests && inputs.build_android }}
    needs: [build-android]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            binary: fuckfile-android-arm64
          - arch: armv7
            binary: fuckfile-android-armv7
          - arch: x86_64
            binary: fuckfile-android-x86_64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: tmp-android
      - name: Verify Binary
        run: |
          ARCH="${{ matrix.arch }}"
          BINARY="./${{ matrix.binary }}"
          LOG="test-android-${ARCH}.log"
          
          echo "=== fuckfile Test - Android $ARCH ===" > $LOG
          echo "Date: $(date)" >> $LOG
          echo "Binary: $BINARY" >> $LOG
          echo "Note: Skipping execution on QEMU due to Bionic Libc instability." >> $LOG
          echo "      Verifying binary existence and file type only." >> $LOG
          echo "" >> $LOG
          
          if [ -f "$BINARY" ]; then
            echo "[PASS] Binary exists." >> $LOG
            file "$BINARY" >> $LOG
            ls -lh "$BINARY" >> $LOG
          else
            echo "[FAIL] Binary not found!" >> $LOG
            exit 1
          fi
          
          cat $LOG

      - uses: actions/upload-artifact@v4
        with:
          name: log-android-${{ matrix.arch }}
          path: test-android-${{ matrix.arch }}.log

  # ==================================================================================
  # 8. DISTRIBUTE (Package & Clean)
  # ==================================================================================
  distribute:
    needs: [build-linux, build-windows-mingw, build-windows-arm64, build-android, test-linux, test-windows, test-android]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Dirs
        run: mkdir -p dist/android dist/windows dist/linux dist/logs_tmp

      # Download Artifacts
      - name: Collect Android
        if: inputs.build_android
        uses: actions/download-artifact@v4
        with:
          name: tmp-android
          path: dist/android
      
      - name: Collect Windows MinGW
        if: inputs.build_windows
        uses: actions/download-artifact@v4
        with:
          name: tmp-windows-mingw
          path: dist/windows
      
      - name: Collect Windows ARM64
        if: inputs.build_windows
        uses: actions/download-artifact@v4
        with:
          name: tmp-windows-arm64
          path: dist/windows
      
      - name: Collect Linux
        if: inputs.build_linux
        uses: actions/download-artifact@v4
        with:
          name: tmp-linux
          path: dist/linux
      
      - name: Collect Logs
        if: inputs.run_tests
        uses: actions/download-artifact@v4
        with:
          pattern: log-*
          path: dist/logs_tmp
          merge-multiple: true

      # Merge Logs
      - name: Create Summary
        if: inputs.run_tests
        run: |
          echo "=== fuckfile Test Summary ===" > test-summary.txt
          echo "Date: $(date)" >> test-summary.txt
          for log in dist/logs_tmp/*.log; do
            if [ -f "$log" ]; then
              echo "" >> test-summary.txt
              echo ">>> $(basename $log)" >> test-summary.txt
              cat "$log" >> test-summary.txt
            fi
          done

      # DELETE TEMPORARY ARTIFACTS
      - name: Cleanup Temp Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            tmp-*
            log-*
          failOnError: false

      # Upload Final
      - name: Upload Android
        if: inputs.build_android
        uses: actions/upload-artifact@v4
        with:
          name: android-binary
          path: dist/android/*
      
      - name: Upload Windows
        if: inputs.build_windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: dist/windows/*
      
      - name: Upload Linux
        if: inputs.build_linux
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: dist/linux/*
      
      - name: Upload Logs
        if: inputs.run_tests
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: test-summary.txt